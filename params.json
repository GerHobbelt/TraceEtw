{"name":"Trace ETW","tagline":"High-performance tracing for C++ Desktop and Windows/Windows Phone Store apps","body":"[![Build status](https://ci.appveyor.com/api/projects/status/d3w7r6o478u53o8d?svg=true)![Test status](http://teststatusbadge.azurewebsites.net/api/status/mmaitre314/traceetw)](https://ci.appveyor.com/project/mmaitre314/traceetw)\r\n[![NuGet package](http://mmaitre314.github.io/images/nuget.png)](https://www.nuget.org/packages/MMaitre.TraceEtw/)\r\n\r\n[Event Tracing for Windows (ETW)](http://msdn.microsoft.com/en-us/library/windows/desktop/aa363668(v=vs.85).aspx) is  powerful but notoriously complex. In C#, [EventSource](http://msdn.microsoft.com/en-us/library/system.diagnostics.tracing.eventsource(v=vs.110).aspx) made that technology much more approachable. This project aims at providing a similar solution for C++, both for Desktop apps and for Windows/Windows Phone Universal Store apps. \r\n\r\nDefining events\r\n---\r\n\r\nTo begin with, add an XML file with an .epx extension (as in 'Event Provider XML') to the Visual Studio project:\r\n\r\n```xml\r\n<?xml version=\"1.0\" encoding=\"utf-8\"?>\r\n<EventProvider\r\n    xmlns:xsi=\"http://www.w3.org/2001/XMLSchema-instance\"\r\n    xsi:noNamespaceSchemaLocation=\"http://mmaitre314.github.io/EventProvider.xsd\"\r\n    Name=\"MMaitre-TraceEtw\" \r\n    Guid=\"{A006BF16-179A-4BDF-A0A2-917AC6CA98D6}\"\r\n    >\r\n\r\n</EventProvider>\r\n```\r\n\r\nwhere the `Name` and `Guid` attributes should be replaced with appropriate values. The GUID can be created using the 'Create GUID' tool in Visual Studio. The `xsi` attributes enable Intellisense.\r\n\r\nA basic marker event with no payload can be added using:\r\n\r\n```xml\r\n<Event Name=\"Marker\" />\r\n```\r\n\r\nWhen the project is compiled a header gets generated from the XML file, which lets the app raise the marker event when appropriate:\r\n\r\n```C++\r\n#include \"Events\\EtwLogger.h\"\r\n\r\nEtwLogger.Marker();\r\n```\r\n\r\nwhere EtwLogger is the name of the .epx file.\r\n\r\n[Windows Performance Analyzer (WPA)](http://msdn.microsoft.com/en-us/library/windows/hardware/hh448170.aspx) will start displaying the event:\r\n\r\n![WPA](http://mmaitre314.github.io/images/TraceEtwWpa.PNG)\r\n\r\nThe XML file allows defining more complex events. Events can have arguments and a trace level:\r\n\r\n```xml\r\n<Event Name=\"Trace\" Level=\"Verbose\">\r\n    <Arg Type=\"Pointer\" Name=\"Object\" />\r\n    <Arg Type=\"UInt32\" Name=\"Count\" />\r\n</Event>\r\n```\r\n\r\n```C++\r\nEtwLogger.Trace(this, 314);\r\n```\r\n\r\nThe default trace level is Informational.\r\n\r\nEvents can also have a variable number of arguments, which generates unstructured traces (i.e. `printf`):\r\n\r\n```xml\r\n<Event Name=\"Trace\">\r\n    <VarArgs Type=\"AnsiString\" Name=\"Message\" />\r\n</Event>\r\n```\r\n\r\n```C++\r\nEtwLogger.Trace(\"Received %i calls from %s\", 3, \"localhost\");\r\n```\r\n\r\nDefining task events allows tracking the beginning and end of long operations:\r\n\r\n```xml\r\n<Task Name=\"ALongOperation\">\r\n    <Start>\r\n        <Arg Type=\"Pointer\" Name=\"Object\" />\r\n    </Start>\r\n    <Stop>\r\n        <Arg Type=\"Pointer\" Name=\"Object\" />\r\n        <Arg Type=\"Int32\" Name=\"HResult\" />\r\n    </Stop>\r\n</Task>\r\n```\r\n\r\n```C++\r\nEtwLogger.ALongOperationStart(this);\r\n...\r\nEtwLogger.ALongOperationStop(this, S_OK);\r\n```\r\n\r\nThe `IsEnabled()` method on the logger class allows traces which may require expensive computations to only run when events are being recorded:\r\n\r\n```C++\r\n\r\nif (EtwLogger.IsEnabled())\r\n{\r\n    string message = GatherTraceInformation()\r\n    EtwLogger.Trace(L\"Trace information: %s\", message.c_str());\r\n}\r\n\r\n```\r\n\r\nRecording and displaying events\r\n---\r\n\r\nBesides the logger header, the build also generates a set of scripts, a WPRP profile, and an event-provider manifest:\r\n\r\n- RegisterEtwLogger.cmd/UnregisterEtwLogger.cmd - scripts to register and unregister the event provider. Must be run elevated.\r\n- TraceEtwLogger.cmd - script to record events.\r\n- EtwLogger.wprp - [recording profile](http://msdn.microsoft.com/en-us/library/windows/hardware/hh448223.aspx) for [Windows Performance Recorder (WPR)](http://msdn.microsoft.com/en-us/library/windows/hardware/hh448205.aspx)\r\n- EtwLogger.man - event-provider manifest\r\n\r\nThe files are placed in the output folder along with the binaries.\r\n\r\nThe trace script relies on xperf to record events. It is part of the [Windows Performance Toolkit](http://msdn.microsoft.com/en-us/library/windows/hardware/hh162945.aspx) like WPA and WPR. Its ability to run a merge pass on the .etl event log files tends to make it more robust when it comes to collecting event-manifest info.\r\n\r\nIn-app event recording\r\n---\r\n\r\nThe project also contains an API for apps to record events fired inside their own process. This is currently not included in the NuGet package as it works in Windows apps but not in Windows Store apps ([EnableTrace()](http://msdn.microsoft.com/en-us/library/windows/desktop/aa363710(v=vs.85).aspx) function banned there).\r\n\r\nRecording events is just a matter of creating an `InProcEventListener` object, passing a file path and the list of event provider GUIDs to enable:\r\n\r\n```C++\r\nauto listener = ref new InProcEventListener(\r\n    ApplicationData::Current->LocalFolder,\r\n    L\"log.etl\",\r\n    ref new Vector<Guid> { MMaitre_TraceEtw }\r\n);\r\n\r\nEtwLogger.Trace(\"1\");\r\n```\r\n\r\n","google":"","note":"Don't delete this file! It's used internally to help with page regeneration."}